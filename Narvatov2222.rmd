---
title: "Лабораторная работа №2"
author: "Нарватов Игорь"
date: "11.12.2020"
output: 
  word_document: 
    reference_docx: word_styles.docx
---


```{r setup, include=FALSE}
# Загрузка библиотек
library('stats') 
#library('nortest')        # для теста Андерсона-Дарлинга ad.test()
library('knitr')
library('Hmisc')          # для расчёта корреляционной матрицы
library('corrplot')       # визуализация корреляционных матриц: corrplot()
#счётчик для таблиц
table.num <- 1
#счётчик для рисунков
pic.num <- 1
knitr::opts_chunk$set(echo = FALSE)
```

##Импорт данных
Импортируем объекты, сохраненные в рабочем пространстве по итогу ЛР№1

```{r import, echo = FALSE}
load('test_lab1_Narvatov.RData')
```

```{r, echo = FALSE}
ls()
dim(reg.df)
head(reg.df)
str(reg.df)
```

# Раздел I.

## Изначальная регрессионная модель, основанная на ЛР№1
Модель 0: $Y = 97.86 + 5.146\cdot 10^{-2} X1 -4.519\cdot 10^{-2} X2 - 3.057\cdot 10^{-6} X3 -9.093 \cdot 10^{-7} X4$, где

* `Y` (*IPI.2015*) – Индексы промышленного производства;   

* `X1` (*PIM.2015*) – Индесы цен производителей промышленных товаров по видам экономической деятельности: обрабатывающие производства;

* `X2` (*DDFA.2015*) – Степень износа основных фондов.   
* `X3` (*FCI.2014*) – Инвестиции в основвной капитал на душу населения.   
* `X4` (*DLR.2015*) – Задолжность по кредитам в рублях, предоставленым кредитными организациями юридическим лицам.


По количеству `r nrow(reg.df)`-x наблюдений.

 ------------------------------------------------
##  Оценка параметров этой моделей 

#### Таблица `r table.num` - описательные статистики модели 1

```{r, echo = FALSE}
# множественная регрессия для всех регионов ====================================
fit.1 <- lm(IPI.2015 ~ PIM.2015 + DDFA.2015 + FCI.2014 + DLR.2015, data = reg.df)
summary(fit.1)  # незначимые параметры
fit.2 <- lm(IPI.2015 ~ DDFA.2015 + FCI.2014 + DLR.2015, data = reg.df)
round(summary(fit.2)$coef, 4)  # незначимые параметры
fit.3 <- lm(IPI.2015 ~ FCI.2014 + DLR.2015, data = reg.df)
round(summary(fit.3)$coef, 4)
fit.X1 <- lm(IPI.2015 ~ DLR.2015, data = reg.df)
kable(round(summary(fit.X1)$coef, 4))
table.num <- table.num + 1
#summary(fit.X1)
par(mfrow = c(1, 2))
plot(IPI.2015 ~DLR.2015, 
            data = reg.df)
reg <- lm(IPI.2015 ~DLR.2015, 
            data = reg.df)
coeff = coefficients(reg)
abline(reg, col="red")
par(mfrow = c(1, 1))
pic.num <- pic.num + 1
```

#### Рис. `r pic.num`. график разброса начальной модели

**Проверка значимости для коэффициента при DLR.2015.**

H0: (параметр) коэфф. при DLR.2015 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при DLR.2015 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения.

**Напоминание:**
*Сравниваем p-значение и $\alpha$ (Уровень значимости = 0,05);*
*Если p-значение > $\alpha$, то принимается гипотеза H0, в ином случае принимается противоположная гипотеза H1.*

P-значение при PIM.2014 = $0.1834 > \alpha$ => принимается гипотеза H0. **Параметр не значим.**

## Пошаговое исключение регрессоров

Исключаем PIM.2015 первым так как у него самое большое p-значение (0.598)
Исключаем DDFA.2015 вторым так как у него самое большое p-значение (0.4818)
Исключаем FCI.2014 третьим так как у него самое большое p-значение (0.2093)

Явный вид модели 1: $Y = 101.8391 +  0.0000	 \cdot X4$



#### Рис. `r pic.num`. график разброса исправленной модели

## модель с переменной структурой по федеральным округам ===============================================
Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.

#### Таблица `r table.num` - описательные статистики модели по федеральным округам

```{r, echo = FALSE}
fit.X1.fo <- lm(IPI.2015 ~ DLR.2015 * FO, data = reg.df)
kable(round(summary(fit.X1.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.X1.fo)
```

Модель в целом незначима, но скорректированный коэффициент
детерминации у неё немного выше, чем у модели по всем регионам (`r round(summary(fit.X1.fo)$r.sq, 3)*100`%). У неё несколько незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сначала сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.

### Модель без поправки:

#### Таблица `r table.num` - описательные статистики модели по федеральным округам без поправки

```{r, echo = FALSE}
# создаём фрейм со всеми переменными-факторами (создаём фиктивные)
X.matrix <- model.matrix(IPI.2015 ~ FO * DLR.2015 , data = reg.df)
# присоединяем независимую переменную
data.fit <- cbind(IPI.2015 = reg.df$DLR.2015, 
                  data.frame(X.matrix)[, -1])
# результат
head(data.fit)
tail(data.fit)
# сохраняем для следующей лабораторной
data.fit.X1.fo <- data.fit
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')
# применяем процедуру, сначала без поправок на p-значения
fit.X1.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'IPI.2015')
kable(round(summary(fit.X1.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.X1.fo)
```

С помощью данной процедуры были исключены почти все показатели, зато модель  имеет высокий уровень коэффициента детерминации. ($R^2 =$ `r round(summary(fit.X1.fo)$r.sq, 3)`)

*( DLR.2015 значима)*

### Модель с поправкой Бонферрони:

Явный вид модели 2: $IPI.2014 =1 \cdot DLR.2015$


#### Таблица `r table.num` - описательные статистики модели по федеральным округам с поправкой Бонферрони

```{r, echo = FALSE}
# теперь с поправкой Бонферрони
fit.X1.foB <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'IPI.2015',
                                   p.adj.method = 'bonferroni')
kable(round(summary(fit.X1.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.X1.fo)
```
Коэффициент модели при *DLR.2015* значим и коэффициент детерминации не  понизился ($R^2 =$ `r round(summary(fit.X1.fo)$r.sq, 3)`).


# строим ПЛР на второй по силе корреляции фактор

Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.


```{r, echo = FALSE}
# строим ПЛР на второй по силе корреляции фактор
fit.X2 <- lm(IPI.2015 ~ FCI.2014, 
             data = reg.df)
#summary(fit.X2)
```

Модель со 2 фактором по силе корреляции не значима, и имеет слабый коэффицент детерминации ($R^2 =$ `r round(summary(fit.X2)$r.sq, 3)`)

#### Таблица `r table.num` - описательные статистики модели по федеральным округам

```{r, echo = FALSE}
# модель с переменной структурой
fit.X2.fo <- lm(IPI.2015 ~ FO * FCI.2014, 
                data = reg.df)
kable(round(summary(fit.X2.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.X2.fo)
```

Модель в целом незначима, и скорректированный коэффициент
детерминации у неё ниже, чем у модели по всем регионам (`r round(summary(fit.X1.fo)$r.sq, 3)*100`%). У неё много незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сначала сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой





 ## Сравнение моделей по качеству.

Сравним три полученные модели: изначальную, с поправкой по ФО и без поправки по ФО.


 #### Таблица `r table.num` - сравнение трёх моделей
```{r, echo = FALSE}
# модели с фактором PIM.2015
#anova(fit.X1, fit.X1.foB, fit.X1.fo)
# список построенных моделей
models.list <- list(fit.X1, fit.X1.foB, fit.X1.fo)
names(models.list) <- c('fit.X1', 'fit.X1.foBonferroni', 'fit.X1.fo')
# фрейм с характеристиками четырёх моделей
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 1)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
mean(reg.df$IPI.2015)
```
Результат: 

Среднее по Y = 101,5675;

По столбцу $R^2$ больше всего подходит вторая модель;
По столбцу F.расч - вторая;
По минимальной Стандартной ошибке -вторая и  третья.

Таким образом, модель по федеральным округам без поправки (fit.X1.foBonferroni) наиболее предпочтительна.

Явный вид модели 3: $IPI.2015 =1 \cdot DLR.2015$



 # Раздел II

 ## Изначаьная регрессионная модель для логарифмированных данных, основанная на ЛР№1

Модель 0: $Y = 4.7073 -  0.0077	 \cdot X4$, где

* `Y` (*IPI.2015*) – Индексы промышленного производства;   

* `X4` (*DLR.2015*) – Задолжность по кредитам в рублях, предоставленым кредитными организациями юридическим лицам.
IPI.2015 =1 \cdot DLR.2015

Федерации: всего;

По количеству `r nrow(DF1)`-x наблюдений.

```{r, echo = FALSE}
# множественная регрессия для всех регионов на логарифмированных данных
fit.11 <- lm(IPI.2015 ~ DLR.2015, 
            data = DF1)
kable(round(summary(fit.11)$coef, 4))  # незначимые параметры
table.num <- table.num + 1
#построим график
par(mfrow = c(1, 2))
plot(IPI.2015 ~ DLR.2015 , 
            data = DF1)
reg <- lm(IPI.2015 ~ DLR.2015, 
            data = DF1)
coeff = coefficients(reg)
abline(reg, col = "red")
par(mfrow = c(1, 1))
pic.num <- pic.num + 1
```
#### Рис. `r pic.num`. график разброса начальной логарифмированной модели

## Проверка значимости для логарифмированных значений:

**Проверка значимости для коэффициента приDLR.2015.**

H0: (параметр) коэфф. при DLR.2015 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при DLR.2015 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения. ( $\alpha = 0,05$ )

P-значение при DLR.2015 = $0<\alpha$ => принимается гипотеза H1. **Параметр значим.**

# Модель с переменной структурой по федеральным округам (логарифмированные данные).

Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.

#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам
```{r, echo = FALSE}
fit.11.fo <- lm(IPI.2015 ~ FO*(DLR.2015), 
            data = DF1) 
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
```

Модель в целом значима, но скорректированный коэффициент
детерминации у неё выше, чем у модели по всем регионам (`r round(summary(fit.11.fo)$r.sq, 3)*100`%). У неё несколько незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сначала сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.

### Модель без поправки:

#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам без поправки

```{r, echo = FALSE}
# создаём фрейм со всеми переменными-факторами (создаём фиктивные)
X.matrix <- model.matrix(IPI.2015 ~ FO*(DLR.2015), data = DF1)
# присоединяем независимую переменную
data.fit <- cbind(IPI.2015 = DF1$IPI.2015, 
                  data.frame(X.matrix)[, -1])
# результат
head(data.fit)
tail(data.fit)
# сохраняем для следующей лабораторной
data.fit.11.fo <- data.fit
# функция с последовательным исключением незначимых регрессоров
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')
# применяем процедуру, сначала без поправок на p-значения
fit.11.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'IPI.2015')
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.11.fo)
```





#### Таблица `r table.num` - сравнение трёх моделей
```{r, echo = FALSE}
# модели с фактором PIM.2015
#anova(fit.11, fit.11.foB, fit.11.fo)
# список построенных моделей
models.list <- list(fit.11)
names(models.list) <- c('fit.11')
# фрейм с характеристиками четырёх моделей
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 1)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
mean(DF1$IPI.2015)
```
Результат: 

Среднее по Y = 4.61937;


Выберем  модель.
**Явный вид модели: $Y = 4.7073 -  0.0077	 \cdot X4$.**
 
 
 	
	
 
 

```{r, echo = FALSE}
# 4. Сохранение нужных объектов рабочего пространства  -------------------------
save(list = c('data.fit.X1.fo', 'data.fit.11.fo', 'fit.X1.fo', 'fit.11.fo', 'DF', 'DF1', 'reg.df' , 'models.list'), 
    file = 'test_lab2_Narvatov.RData')
```